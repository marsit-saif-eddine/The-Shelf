import { createSlice, createAsyncThunk } from "@reduxjs/toolkit";
import axios from "axios";
const { io } = require("socket.io-client");

export const getClubConversation = createAsyncThunk(
    "clubs/getClubConversation",
    club_id => axios
        .get("clubs/getClubConversation", {
          params: { club_id },
        })
        .then((resp) => {
      return {
        data: resp.data
      }
    })
  );

export const ChatSlice = createSlice({
  name: "chat",
  initialState: {
    chatBubbles: [],
    privateConversations: [],
    clubConversations: [],
    socket: null,
  },
  reducers: {
    // PAYLOAD TYPE : {
    //   _id: ''
    //   lastname: '',
    //   firstname: '',
    //   photo: '',
    //   newContent: ''
    // }
    addChatBubble: (state, action) => {
      if (state.chatBubbles.findIndex((x) => x._id === action.payload._id) < 0)
        state.chatBubbles.push(action.payload);
    },

    // PAYLOAD index: int
    closeChatBubble: (state, action) => {
      state.chatBubbles.splice(action.payload, 1);
    },

    markNewContentAsRead: (state, action) => {
      state.chatBubbles[action.payload].newContent = null;
    },

    initSocketConnection: (state, action) => {
      state.socket = io("http://localhost:5000", {
        auth: {
          user_id: JSON.parse(localStorage.getItem('userData'))._id,
        },
      });

      state.socket.on("connect", () => {});

    },

    clubMessageReceived: (state, action) => {
        const conversation = state.clubConversations.find(
            (x) => x.club_id === action.payload.club_id
          );
          if (conversation) {
            delete action.payload.club_id;
            conversation.messages.push(action.payload);
          }
    }

  },
  extraReducers: (builder) => {
    builder.addCase(getClubConversation.fulfilled, (state, action) => {
        const data = action.payload.data;
        if (data) {
            const index = state.clubConversations.findIndex(
              (x) => x.club_id === action.payload.club_id
            );
            if (index < 0) {
              state.clubConversations.push(data);
            } else {
              state.clubConversations[index] = data;
            }
          } else {
            state.clubConversations.push({
              club_id: action.payload,
              messages: [],
            });
          }
    });
  },
});

export const {
  addChatBubble,
  closeChatBubble,
  markNewContentAsRead,
  clubMessageReceived,
  initSocketConnection,
} = ChatSlice.actions;

export default ChatSlice.reducer;
